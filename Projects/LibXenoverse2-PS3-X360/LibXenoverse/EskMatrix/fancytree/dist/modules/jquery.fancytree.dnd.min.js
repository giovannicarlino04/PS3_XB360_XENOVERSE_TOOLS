(function(e){"function"==typeof define&&define.amd?define(["jquery","jquery-ui/ui/widgets/draggable","jquery-ui/ui/widgets/droppable","./jquery.fancytree"],e):"object"==typeof module&&module.exports?(require("./jquery.fancytree"),module.exports=e(require("jquery"))):e(jQuery)})(function(e){"use strict";function r(e){return 0===e?"":e>0?"+"+e:""+e}function t(){n||(e.ui.plugin.add("draggable","connectToFancytree",{start:function(r,t){var a=e(this).data("ui-draggable")||e(this).data("draggable"),n=t.helper.data("ftSourceNode")||null;if(n)return a.offset.click.top=-2,a.offset.click.left=16,n.tree.ext.dnd._onDragEvent("start",n,null,r,t,a)},drag:function(r,t){var a,n,o,d=e(this).data("ui-draggable")||e(this).data("draggable"),l=t.helper.data("ftSourceNode")||null,s=t.helper.data("ftTargetNode")||null,i=e.ui.fancytree.getNode(r.target),p=l&&l.tree.options.dnd;if(r.target&&!i&&(n=e(r.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0,n))return o=l||s||e.ui.fancytree,void o.debug("Drag event over helper: ignored.");t.helper.data("ftTargetNode",i),p&&p.updateHelper&&(a=l.tree._makeHookContext(l,r,{otherNode:i,ui:t,draggable:d,dropMarker:e("#fancytree-drop-marker")}),p.updateHelper.call(l.tree,l,a)),s&&s!==i&&s.tree.ext.dnd._onDragEvent("leave",s,l,r,t,d),i&&i.tree.options.dnd.dragDrop&&(i===s?i.tree.ext.dnd._onDragEvent("over",i,l,r,t,d):(i.tree.ext.dnd._onDragEvent("enter",i,l,r,t,d),i.tree.ext.dnd._onDragEvent("over",i,l,r,t,d)))},stop:function(r,t){var a,n=e(this).data("ui-draggable")||e(this).data("draggable"),o=t.helper.data("ftSourceNode")||null,d=t.helper.data("ftTargetNode")||null,l="mouseup"===r.type&&1===r.which;l||(a=o||d||e.ui.fancytree,a.debug("Drag was cancelled")),d&&(l&&d.tree.ext.dnd._onDragEvent("drop",d,o,r,t,n),d.tree.ext.dnd._onDragEvent("leave",d,o,r,t,n)),o&&o.tree.ext.dnd._onDragEvent("stop",o,null,r,t,n)}}),n=!0)}function a(r){var a=r.options.dnd||null,n=r.options.glyph||null;a&&t(),a&&a.dragStart&&r.widget.element.draggable(e.extend({addClasses:!1,appendTo:r.$container,containment:!1,delay:0,distance:4,revert:!1,scroll:!0,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:!0,helper:function(r){var t,a,o,d=e.ui.fancytree.getNode(r.target);return d?(o=d.tree.options.dnd,a=e(d.span),t=e("<div class='fancytree-drag-helper'><span class='fancytree-drag-helper-img' /></div>").css({zIndex:3,position:"relative"}).append(a.find("span.fancytree-title").clone()),t.data("ftSourceNode",d),n&&t.find(".fancytree-drag-helper-img").addClass(n.map._addClass+" "+n.map.dragHelper),o.initHelper&&o.initHelper.call(d.tree,d,{node:d,tree:d.tree,originalEvent:r,ui:{helper:t}}),t):"<div>ERROR?: helper requested but sourceNode not found</div>"},start:function(e,r){var t=r.helper.data("ftSourceNode");return!!t}},r.options.dnd.draggable)),a&&a.dragDrop&&r.widget.element.droppable(e.extend({addClasses:!1,tolerance:"intersect",greedy:!1},r.options.dnd.droppable))}var n=!1,o="fancytree-drop-accept",d="fancytree-drop-after",l="fancytree-drop-before",s="fancytree-drop-over",i="fancytree-drop-reject",p="fancytree-drop-target";return e.ui.fancytree.registerExtension({name:"dnd",version:"2.30.0",options:{autoExpandMS:1e3,draggable:null,droppable:null,focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,smartRevert:!0,dropMarkerOffsetX:-24,dropMarkerInsertOffsetX:-16,dragStart:null,dragStop:null,initHelper:null,updateHelper:null,dragEnter:null,dragOver:null,dragExpand:null,dragDrop:null,dragLeave:null},treeInit:function(r){var t=r.tree;this._superApply(arguments),t.options.dnd.dragStart&&t.$container.on("mousedown",function(t){if(r.options.dnd.focusOnClick){var a=e.ui.fancytree.getNode(t);a&&a.debug("Re-enable focus that was prevented by jQuery UI draggable."),setTimeout(function(){e(t.target).closest(":tabbable").focus()},10)}}),a(t)},_setDndStatus:function(t,a,n,g,u){var c,f,v="center",h=this._local,y=this.options.dnd,b=this.options.glyph,m=t?e(t.span):null,x=e(a.span),k=x.find("span.fancytree-title");if(h.$dropMarker||(h.$dropMarker=e("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1e3}).prependTo(e(this.$div).parent()),b&&h.$dropMarker.addClass(b.map._addClass+" "+b.map.dropMarker)),"after"===g||"before"===g||"over"===g){switch(c=y.dropMarkerOffsetX||0,g){case"before":v="top",c+=y.dropMarkerInsertOffsetX||0;break;case"after":v="bottom",c+=y.dropMarkerInsertOffsetX||0}f={my:"left"+r(c)+" center",at:"left "+v,of:k},this.options.rtl&&(f.my="right"+r(-c)+" center",f.at="right "+v),h.$dropMarker.toggleClass(d,"after"===g).toggleClass(s,"over"===g).toggleClass(l,"before"===g).toggleClass("fancytree-rtl",!!this.options.rtl).show().position(e.ui.fancytree.fixPositionOptions(f))}else h.$dropMarker.hide();m&&m.toggleClass(o,!0===u).toggleClass(i,!1===u),x.toggleClass(p,"after"===g||"before"===g||"over"===g).toggleClass(d,"after"===g).toggleClass(l,"before"===g).toggleClass(o,!0===u).toggleClass(i,!1===u),n.toggleClass(o,!0===u).toggleClass(i,!1===u)},_onDragEvent:function(r,t,a,n,o,d){var l,s,i,p,g,u,c,f,v,h=this.options,y=h.dnd,b=this._makeHookContext(t,n,{otherNode:a,ui:o,draggable:d}),m=null,x=this,k=e(t.span);switch(y.smartRevert&&(d.options.revert="invalid"),r){case"start":t.isStatusNode()?m=!1:y.dragStart&&(m=y.dragStart(t,b)),!1===m?(this.debug("tree.dragStart() cancelled"),o.helper.trigger("mouseup").hide()):(y.smartRevert&&(p=t[b.tree.nodeContainerAttrName].getBoundingClientRect(),i=e(d.options.appendTo)[0].getBoundingClientRect(),d.originalPosition.left=Math.max(0,p.left-i.left),d.originalPosition.top=Math.max(0,p.top-i.top)),k.addClass("fancytree-drag-source"),e(document).on("keydown.fancytree-dnd,mousedown.fancytree-dnd",function(r){"keydown"===r.type&&r.which===e.ui.keyCode.ESCAPE?x.ext.dnd._cancelDrag():"mousedown"===r.type&&x.ext.dnd._cancelDrag()}));break;case"enter":v=(!y.preventRecursiveMoves||!t.isDescendantOf(a))&&(y.dragEnter?y.dragEnter(t,b):null),m=!!v&&(e.isArray(v)?{over:e.inArray("over",v)>=0,before:e.inArray("before",v)>=0,after:e.inArray("after",v)>=0}:{over:!0===v||"over"===v,before:!0===v||"before"===v,after:!0===v||"after"===v}),o.helper.data("enterResponse",m);break;case"over":c=o.helper.data("enterResponse"),f=null,!1===c||("string"==typeof c?f=c:(s=k.offset(),g={x:n.pageX-s.left,y:n.pageY-s.top},u={x:g.x/k.width(),y:g.y/k.height()},c.after&&u.y>.75?f="after":!c.over&&c.after&&u.y>.5?f="after":c.before&&u.y<=.25?f="before":!c.over&&c.before&&u.y<=.5?f="before":c.over&&(f="over"),y.preventVoidMoves&&(t===a?(this.debug("    drop over source node prevented"),f=null):"before"===f&&a&&t===a.getNextSibling()?(this.debug("    drop after source node prevented"),f=null):"after"===f&&a&&t===a.getPrevSibling()?(this.debug("    drop before source node prevented"),f=null):"over"===f&&a&&a.parent===t&&a.isLastSibling()&&(this.debug("    drop last child over own parent prevented"),f=null)),o.helper.data("hitMode",f))),"before"===f||"after"===f||!y.autoExpandMS||!1===t.hasChildren()||t.expanded||y.dragExpand&&!1===y.dragExpand(t,b)||t.scheduleAction("expand",y.autoExpandMS),f&&y.dragOver&&(b.hitMode=f,m=y.dragOver(t,b)),l=!1!==m&&null!==f,y.smartRevert&&(d.options.revert=!l),this._local._setDndStatus(a,t,o.helper,f,l);break;case"drop":f=o.helper.data("hitMode"),f&&y.dragDrop&&(b.hitMode=f,y.dragDrop(t,b));break;case"leave":t.scheduleAction("cancel"),o.helper.data("enterResponse",null),o.helper.data("hitMode",null),this._local._setDndStatus(a,t,o.helper,"out",void 0),y.dragLeave&&y.dragLeave(t,b);break;case"stop":k.removeClass("fancytree-drag-source"),e(document).off(".fancytree-dnd"),y.dragStop&&y.dragStop(t,b);break;default:e.error("Unsupported drag event: "+r)}return m},_cancelDrag:function(){var r=e.ui.ddmanager.current;r&&r.cancel()}}),e.ui.fancytree});